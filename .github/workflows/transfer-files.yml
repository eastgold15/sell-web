name: "ä¼ è¾“éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨"

on:
  workflow_dispatch:
    inputs:
      force_transfer:
        description: 'å¼ºåˆ¶ä¼ è¾“æ‰€æœ‰æ–‡ä»¶(è¦†ç›–)'
        required: false
        default: 'false'
        type: boolean
  workflow_call:
    inputs:
      force_transfer:
        description: 'å¼ºåˆ¶ä¼ è¾“æ‰€æœ‰æ–‡ä»¶'
        required: false
        default: false
        type: boolean

env:
  PROJECT_NAME: MechanicEndWorld2 # é¡¹ç›®åç§°
  PROJECT_DIR: /1/MechanicEndWorld2  #æœåŠ¡å™¨é¡¹ç›®ç›®å½•
  SERVER_PORT: 22

jobs:
  transfer-files:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç ä»¥è·å–éƒ¨ç½²æ–‡ä»¶
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # Step 2: éªŒè¯éƒ¨ç½²æ–‡ä»¶
      - name: ğŸ” éªŒè¯éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ğŸ“ æ£€æŸ¥æœ¬åœ°éƒ¨ç½²æ–‡ä»¶..."
          ls -la .container/prod/
          ls -la .env
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=(
            ".container/prod/docker-compose.prod.yml"
            ".container/prod/.env.production"
            ".container/prod/Caddyfile"
            ".env"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
              exit 1
            else
              echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            fi
          done

      # Step 3: ä¼ è¾“éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: ğŸ“ ä¼ è¾“éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ env.SERVER_PORT || '22'}}
          source: ".container/prod/*,.env"
          target: ${{ env.PROJECT_DIR }}
          strip_components: 0
          debug: true # æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
          timeout: 3m # å¢åŠ è¶…æ—¶æ—¶é—´
          overwrite: ${{ github.event.inputs.force_transfer == 'true' }}

      # Step 4: éªŒè¯æœåŠ¡å™¨æ–‡ä»¶
      - name: ğŸ” éªŒè¯æœåŠ¡å™¨æ–‡ä»¶
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            set -euo pipefail
            cd ${{ env.PROJECT_DIR }} || { echo "âŒ ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            echo "ğŸ“ éªŒè¯æœåŠ¡å™¨æ–‡ä»¶ç»“æ„..."
            ls -la .container/prod/
            ls -la .env
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "ğŸ” æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶..."
            if [ -f ".container/prod/docker-compose.prod.yml" ]; then
              echo "âœ… docker-compose.prod.yml å­˜åœ¨"
            else
              echo "âŒ docker-compose.prod.yml ä¸å­˜åœ¨"
              exit 1
            fi
            
            if [ -f ".container/prod/Caddyfile" ]; then
              echo "âœ… Caddyfile å­˜åœ¨"
            else
              echo "âŒ Caddyfile ä¸å­˜åœ¨"
              exit 1
            fi
            
            if [ -f ".env" ]; then
              echo "âœ… .env å­˜åœ¨"
            else
              echo "âŒ .env ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "ğŸ‰ æ–‡ä»¶ä¼ è¾“éªŒè¯å®Œæˆï¼"
