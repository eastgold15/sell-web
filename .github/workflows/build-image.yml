name: "æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘ACR"

on:
  workflow_dispatch:
  workflow_call:
  # release:
  #   types: [published]

env:
  REGISTRY: registry.cn-chengdu.aliyuncs.com # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
  IMAGE_NAME: elysia-start # é•œåƒåç§°ä½¿ç”¨å®é™…ä»“åº“å

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version-tag: ${{ steps.extract-tag.outputs.version }}

    steps:
      # Step 1: æ‹‰å–ä»“åº“ä»£ç åˆ° Runner
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Step 2: ç™»å½•åˆ°é˜¿é‡Œäº‘ä»“åº“
      - name: ğŸ” ç™»å½•åˆ°é˜¿é‡Œäº‘ä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      # Step 3: ç”Ÿæˆdocker æ ‡ç­¾
      - name: ğŸ“Œ ç”Ÿæˆdocker æ ‡ç­¾
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Git tag è‡ªåŠ¨ç‰ˆæœ¬ (ä»…åœ¨ release æ—¶)
            type=semver,pattern={{version}},enable=${{ github.event_name == 'release' }} # å¦‚ tag v1.0.0 â†’ name/app:1.0.0
            type=ref,event=branch     # å¦‚ main â†’ name/app:main
            type=ref,event=pr         # å¦‚ pr/2/merge â†’ name/app:pr-2
            # æ€»æ˜¯ç”Ÿæˆ latest æ ‡ç­¾
            type=raw,value=latest
        env:
          DOCKER_METADATA_SHORT_SHA_LENGTH: 7

      # Step 4: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º Docker é•œåƒ"
          echo "ğŸ“‚ æ„å»ºä¸Šä¸‹æ–‡: ."
          echo "ğŸ³ Dockerfile: .container/prod/Dockerfile"
          echo "ğŸ“¦ å°†ç”Ÿæˆçš„æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
          echo "---"

      - name: ğŸ³æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .container/prod/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # Step 5: æå–ç‰ˆæœ¬æ ‡ç­¾
      - name: ğŸ·ï¸ æå–ç‰ˆæœ¬æ ‡ç­¾
        id: extract-tag
        run: |
          TAGS="${{ steps.meta.outputs.tags }}"
          echo "æ‰€æœ‰æ ‡ç­¾: $TAGS"
          
          # æå–ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¼˜å…ˆä½¿ç”¨semveræ ‡ç­¾ï¼Œå¦åˆ™ä½¿ç”¨latestï¼‰
          if echo "$TAGS" | grep -q ":v\?[0-9]\+\.[0-9]\+\.[0-9]\+"; then
            VERSION_TAG=$(echo "$TAGS" | grep -o ":v\?[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 | sed 's/^://')
          else
            VERSION_TAG="latest"
          fi
          
          echo "æå–çš„ç‰ˆæœ¬æ ‡ç­¾: $VERSION_TAG"
          echo "version=$VERSION_TAG" >> $GITHUB_OUTPUT

      # Step 6: è¾“å‡ºé•œåƒä¿¡æ¯
      - name: ğŸ“‹ è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "ğŸ‰ é•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: ${{ steps.extract-tag.outputs.version }}"
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾åˆ—è¡¨:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'
          echo "ğŸ“ é•œåƒä»“åº“: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "ğŸ”— æ‹‰å–å‘½ä»¤ç¤ºä¾‹:"
          echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.extract-tag.outputs.version }}"
