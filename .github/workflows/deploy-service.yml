name: "éƒ¨ç½²å’Œå¯åŠ¨æœåŠ¡"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ğŸ·ï¸ æŒ‡å®šé•œåƒæ ‡ç­¾ (é»˜è®¤ä½¿ç”¨latest)'
        required: false
        default: 'latest'
        type: string
      force_recreate:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨'
        required: false
        default: 'false'
        type: boolean
      service_action:
        description: 'ğŸ¯ æœåŠ¡æ“ä½œ'
        required: false
        default: 'deploy'
        type: choice
        options:
          - deploy
          - restart
          - stop
          - status
  workflow_call:
    inputs:
      image_tag:
        description: 'æŒ‡å®šé•œåƒæ ‡ç­¾ (é»˜è®¤ä½¿ç”¨latest)'
        required: false
        default: 'latest'
        type: string
      force_recreate:
        description: 'å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨'
        required: false
        default: false
        type: boolean
      service_action:
        description: 'æœåŠ¡æ“ä½œ'
        required: false
        default: 'deploy'
        type: string

env:
  PROJECT_NAME: elysia-start # é¡¹ç›®åç§°
  PROJECT_DIR: /1/elysia-start  #æœåŠ¡å™¨é¡¹ç›®ç›®å½•
  SERVER_PORT: 22
  REGISTRY: registry.cn-chengdu.aliyuncs.com
  IMAGE_NAME: elysia-start

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            set -euo pipefail
            cd ${{ env.PROJECT_DIR }} || { echo "âŒ ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶ç»“æ„..."
            ls -la .container/prod/
            ls -la .env
            
            echo "ğŸ›‘ åœæ­¢å¹¶æ¸…ç†æ—§æœåŠ¡..."
            cd .container/prod
            
            # åœæ­¢ç°æœ‰æœåŠ¡
            if docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production ps -q | grep -q .; then
              echo "åœæ­¢ç°æœ‰æœåŠ¡..."
              docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production down --remove-orphans
            else
              echo "æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡"
            fi
            
            # æ¸…ç†æ‚¬ç©ºé•œåƒå’Œå®¹å™¨
            echo "ğŸ§¹ æ¸…ç†æ‚¬ç©ºèµ„æº..."
            docker system prune -f || true
            
            # è®¾ç½®é•œåƒæ ‡ç­¾
            IMAGE_TAG="${{ github.event.inputs.image_tag || 'latest' }}"
            SERVICE_ACTION="${{ github.event.inputs.service_action || 'deploy' }}"
            echo "ğŸ“¦ ä½¿ç”¨é•œåƒæ ‡ç­¾: $IMAGE_TAG"
            echo "ğŸ¯ æœåŠ¡æ“ä½œ: $SERVICE_ACTION"
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export IMAGE_TAG=$IMAGE_TAG
            
            # æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œä¸åŒçš„å‘½ä»¤
            case $SERVICE_ACTION in
              "deploy")
                echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
                docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG
                
                echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
                if [ "${{ github.event.inputs.force_recreate }}" = "true" ]; then
                  docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production up -d --force-recreate
                else
                  docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production up -d
                fi
                ;;
              "restart")
                echo "ğŸ”„ é‡å¯æœåŠ¡..."
                docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production restart
                ;;
              "stop")
                echo "ğŸ›‘ åœæ­¢æœåŠ¡..."
                docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production down
                exit 0
                ;;
              "status")
                echo "ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€..."
                docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production ps
                docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production logs --tail 20
                exit 0
                ;;
              *)
                echo "âŒ æœªçŸ¥çš„æœåŠ¡æ“ä½œ: $SERVICE_ACTION"
                exit 1
                ;;
            esac
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # éªŒè¯æœåŠ¡çŠ¶æ€
            echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
            docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production ps
            
            # æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
            echo "ğŸ¥ æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€..."
            for container in $(docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production ps -q); do
              container_name=$(docker inspect --format='{{.Name}}' $container | sed 's/^\///')
              status=$(docker inspect --format='{{.State.Status}}' $container)
              echo "å®¹å™¨ $container_name: $status"
              
              if [ "$status" != "running" ]; then
                echo "âŒ å®¹å™¨ $container_name æœªæ­£å¸¸è¿è¡Œ"
                echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
                docker logs $container --tail 50
                exit 1
              fi
            done
            
            # æ˜¾ç¤ºæœåŠ¡æ—¥å¿—
            echo "ğŸ“‹ æœåŠ¡å¯åŠ¨æ—¥å¿—:"
            docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production logs --tail 20
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f || true
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼æœåŠ¡å·²æˆåŠŸå¯åŠ¨"
            
            # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
            echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€:"
            docker-compose -f docker-compose.prod.yml --env-file ../../.env --env-file .env.production ps
