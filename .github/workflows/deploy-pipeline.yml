name: "ğŸš€ å®Œæ•´éƒ¨ç½²ç®¡é“ (æ„å»º+éƒ¨ç½²)"

on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'â­ï¸ è·³è¿‡æ„å»ºæ­¥éª¤ï¼ˆä½¿ç”¨ç°æœ‰é•œåƒï¼‰'
        required: false
        default: false
        type: boolean
      image_tag:
        description: 'ğŸ·ï¸ æŒ‡å®šé•œåƒæ ‡ç­¾ (è·³è¿‡æ„å»ºæ—¶ä½¿ç”¨)'
        required: false
        default: 'latest'
        type: string
      force_recreate:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨'
        required: false
        default: false
        type: boolean
      auto_deploy:
        description: 'ğŸ¯ æ„å»ºå®Œæˆåè‡ªåŠ¨éƒ¨ç½²'
        required: false
        default: true
        type: boolean

  release:
    types: [published]

env:
  REGISTRY: registry.cn-chengdu.aliyuncs.com
  IMAGE_NAME: docker-tzd/mechanicendworld


jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ„å»ºé•œåƒ
  build:
    name: "ğŸ”¨ æ„å»º Docker é•œåƒ"
    if: github.event.inputs.skip_build != 'true'
    uses: ./.github/workflows/build-image.yml
    secrets: inherit

  # ç¬¬äºŒæ­¥ï¼šä¼ è¾“æ–‡ä»¶
  transfer:
    name: "ğŸ“ ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨"
    needs: [build]
    if: always() && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    uses: ./.github/workflows/transfer-files.yml
    secrets: inherit

  # ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²æœåŠ¡
  deploy:
    name: "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    needs: [build, transfer]
    if: always() && needs.transfer.result == 'success' && github.event.inputs.auto_deploy != 'false'
    uses: ./.github/workflows/deploy-service.yml
    with:
      image_tag: ${{ github.event.inputs.skip_build == 'true' && github.event.inputs.image_tag || needs.build.outputs['version-tag'] || 'latest' }}
      force_recreate: ${{ github.event.inputs.force_recreate }}
      service_action: 'deploy'
    secrets: inherit

  # æ±‡æ€»ç»“æœ
  summary:
    name: "ğŸ“‹ éƒ¨ç½²æ‘˜è¦"
    needs: [build, transfer, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          echo "## ğŸ‰ éƒ¨ç½²ç®¡é“æ‰§è¡Œå®Œæˆ"
          echo ""
          echo "### ğŸ“¦ æ„å»ºä¿¡æ¯"
          if [ "${{ github.event.inputs.skip_build }}" = "true" ]; then
            echo "- æ„å»ºçŠ¶æ€: â­ï¸ è·³è¿‡"
            echo "- ä½¿ç”¨é•œåƒ: ${{ github.event.inputs.image_tag }}"
          else
            echo "- æ„å»ºçŠ¶æ€: ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
            if [ "${{ needs.build.result }}" = "success" ]; then
              echo "- é•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘ ACR"
              echo "- æ„å»ºæ ‡ç­¾: ${{ needs.build.outputs['version-tag'] }}"
            fi
          fi
          echo ""
          echo "### ğŸ“ æ–‡ä»¶ä¼ è¾“"
          echo "- ä¼ è¾“çŠ¶æ€: ${{ needs.transfer.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
          echo ""
          echo "### ğŸš€ éƒ¨ç½²ä¿¡æ¯"
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "- éƒ¨ç½²çŠ¶æ€: âœ… æˆåŠŸ"
            DEPLOY_TAG="${{ github.event.inputs.skip_build == 'true' && github.event.inputs.image_tag || needs.build.outputs['version-tag'] || 'latest' }}"
            echo "- ä½¿ç”¨é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DEPLOY_TAG"
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            echo "- éƒ¨ç½²çŠ¶æ€: â­ï¸ è·³è¿‡ (auto_deploy=false)"
          else
            echo "- éƒ¨ç½²çŠ¶æ€: âŒ å¤±è´¥"
          fi
          echo ""
          echo "### ğŸ”— å¿«é€Ÿæ“ä½œ"
          echo "- æŸ¥çœ‹æœåŠ¡çŠ¶æ€: æ‰‹åŠ¨è¿è¡Œ 'deploy-service.yml' å·¥ä½œæµï¼Œé€‰æ‹© 'status' æ“ä½œ"
          echo "- é‡å¯æœåŠ¡: æ‰‹åŠ¨è¿è¡Œ 'deploy-service.yml' å·¥ä½œæµï¼Œé€‰æ‹© 'restart' æ“ä½œ"
          FINAL_TAG="${{ github.event.inputs.skip_build == 'true' && github.event.inputs.image_tag || needs.build.outputs['version-tag'] || 'latest' }}"
          echo "- æ‹‰å–é•œåƒ: \`docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$FINAL_TAG\`"
